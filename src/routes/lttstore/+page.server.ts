import { error } from "@sveltejs/kit";
import type { PageServerLoad } from "./$types";
import type { D1Database } from "@cloudflare/workers-types";
import { dev } from "$app/environment";


export const load = (async ({platform}) => {
  const db: D1Database | undefined = platform?.env?.LTTSTORE_DB;
  if(!db) throw error(503, "DB unavailable!");

  if(dev) {
    await db.prepare("create table if not exists products (handle text, id integer PRIMARY KEY, title text, product text, stock string, purchasesPerHour integer, regularPrice integer, currentPrice integer, firstSeen integer, available integer)")
      .run();
  }

  const popularProducts = await db.prepare("select * from products order by purchasesPerHour DESC limit 10")
    .all()
    .then(r => r.results);

  if(dev && popularProducts.length == 0) {
    popularProducts.push({
      handle: "book",
      id: 4752150888551,
      title: "The ABC's of Gaming - Board Book",
      product: "{\"id\":4752150888551,\"title\":\"The ABC's of Gaming - Board Book\",\"handle\":\"book\",\"description\":\"<p>The ABC's of Gaming is Linus Media Group's first fully custom illustrated board book, and aims to provide a fun tech-themed ABC journey for both kids and adults.</p>\\n<p>It's perfect to read aloud to kids ages 6m-3yr who are learning the alphabet, but the fun rhymes and bright illustrations can be enjoyed by older kids as well.</p>\\n<p><br></p>\",\"published_at\":\"2020-11-23T17:04:36-08:00\",\"created_at\":\"2020-11-23T15:55:15-08:00\",\"vendor\":\"Linus Tech Tips Store\",\"type\":\"Home & Office\",\"tags\":[\"bis-paused\"],\"price\":1499,\"price_min\":1499,\"price_max\":1499,\"available\":true,\"price_varies\":false,\"compare_at_price\":null,\"compare_at_price_min\":0,\"compare_at_price_max\":0,\"compare_at_price_varies\":false,\"variants\":[{\"id\":33034899325031,\"title\":\"Default Title\",\"option1\":\"Default Title\",\"option2\":null,\"option3\":null,\"sku\":\"1100\",\"requires_shipping\":true,\"taxable\":true,\"featured_image\":null,\"available\":true,\"name\":\"The ABC's of Gaming - Board Book\",\"public_title\":null,\"options\":[\"Default Title\"],\"price\":1499,\"weight\":227,\"compare_at_price\":null,\"inventory_management\":\"shopify\",\"barcode\":\"\",\"quantity_rule\":{\"min\":1,\"max\":null,\"increment\":1},\"quantity_price_breaks\":[],\"requires_selling_plan\":false,\"selling_plan_allocations\":[]}],\"images\":[\"//cdn.shopify.com/s/files/1/0058/4538/5314/products/Lttstore_ABCsOfGaming_TransparencyFile.png?v=1633033056\",\"//cdn.shopify.com/s/files/1/0058/4538/5314/products/Backcover.jpg?v=1633033061\",\"//cdn.shopify.com/s/files/1/0058/4538/5314/products/Frontcoveropened.jpg?v=1633033061\",\"//cdn.shopify.com/s/files/1/0058/4538/5314/products/Backcoveropen.jpg?v=1633033061\",\"//cdn.shopify.com/s/files/1/0058/4538/5314/products/Spine.jpg?v=1633033061\",\"//cdn.shopify.com/s/files/1/0058/4538/5314/products/ABopenpage.jpg?v=1633033061\",\"//cdn.shopify.com/s/files/1/0058/4538/5314/products/KLopenpage.jpg?v=1633033061\",\"//cdn.shopify.com/s/files/1/0058/4538/5314/products/Acknowledgementopenpage.jpg?v=1633033061\",\"//cdn.shopify.com/s/files/1/0058/4538/5314/products/ABCBookForWeb2000px-9.jpg?v=1633033061\",\"//cdn.shopify.com/s/files/1/0058/4538/5314/products/ABCBookForWeb2000px-10.jpg?v=1633033061\",\"//cdn.shopify.com/s/files/1/0058/4538/5314/products/ABCBookForWeb2000px-11.jpg?v=1633033061\"],\"featured_image\":\"//cdn.shopify.com/s/files/1/0058/4538/5314/products/Lttstore_ABCsOfGaming_TransparencyFile.png?v=1633033056\",\"options\":[{\"name\":\"Title\",\"position\":1,\"values\":[\"Default Title\"]}],\"url\":\"/products/book\",\"media\":[{\"alt\":null,\"id\":21067658362983,\"position\":1,\"preview_image\":{\"aspect_ratio\":1,\"height\":1200,\"width\":1200,\"src\":\"https://cdn.shopify.com/s/files/1/0058/4538/5314/products/Lttstore_ABCsOfGaming_TransparencyFile.png?v=1633033056\"},\"aspect_ratio\":1,\"height\":1200,\"media_type\":\"image\",\"src\":\"https://cdn.shopify.com/s/files/1/0058/4538/5314/products/Lttstore_ABCsOfGaming_TransparencyFile.png?v=1633033056\",\"width\":1200},{\"alt\":null,\"id\":20647777206375,\"position\":2,\"preview_image\":{\"aspect_ratio\":1.143,\"height\":1225,\"width\":1400,\"src\":\"https://cdn.shopify.com/s/files/1/0058/4538/5314/products/Backcover.jpg?v=1633033061\"},\"aspect_ratio\":1.143,\"height\":1225,\"media_type\":\"image\",\"src\":\"https://cdn.shopify.com/s/files/1/0058/4538/5314/products/Backcover.jpg?v=1633033061\",\"width\":1400},{\"alt\":null,\"id\":20647777239143,\"position\":3,\"preview_image\":{\"aspect_ratio\":1.143,\"height\":1225,\"width\":1400,\"src\":\"https://cdn.shopify.com/s/files/1/0058/4538/5314/products/Frontcoveropened.jpg?v=1633033061\"},\"aspect_ratio\":1.143,\"height\":1225,\"media_type\":\"image\",\"src\":\"https://cdn.shopify.com/s/files/1/0058/4538/5314/products/Frontcoveropened.jpg?v=1633033061\",\"width\":1400},{\"alt\":null,\"id\":20647777173607,\"position\":4,\"preview_image\":{\"aspect_ratio\":1.143,\"height\":1225,\"width\":1400,\"src\":\"https://cdn.shopify.com/s/files/1/0058/4538/5314/products/Backcoveropen.jpg?v=1633033061\"},\"aspect_ratio\":1.143,\"height\":1225,\"media_type\":\"image\",\"src\":\"https://cdn.shopify.com/s/files/1/0058/4538/5314/products/Backcoveropen.jpg?v=1633033061\",\"width\":1400},{\"alt\":null,\"id\":20647777337447,\"position\":5,\"preview_image\":{\"aspect_ratio\":1.143,\"height\":1225,\"width\":1400,\"src\":\"https://cdn.shopify.com/s/files/1/0058/4538/5314/products/Spine.jpg?v=1633033061\"},\"aspect_ratio\":1.143,\"height\":1225,\"media_type\":\"image\",\"src\":\"https://cdn.shopify.com/s/files/1/0058/4538/5314/products/Spine.jpg?v=1633033061\",\"width\":1400},{\"alt\":null,\"id\":20647777108071,\"position\":6,\"preview_image\":{\"aspect_ratio\":1.551,\"height\":1225,\"width\":1900,\"src\":\"https://cdn.shopify.com/s/files/1/0058/4538/5314/products/ABopenpage.jpg?v=1633033061\"},\"aspect_ratio\":1.551,\"height\":1225,\"media_type\":\"image\",\"src\":\"https://cdn.shopify.com/s/files/1/0058/4538/5314/products/ABopenpage.jpg?v=1633033061\",\"width\":1900},{\"alt\":null,\"id\":20647777304679,\"position\":7,\"preview_image\":{\"aspect_ratio\":1.551,\"height\":1225,\"width\":1900,\"src\":\"https://cdn.shopify.com/s/files/1/0058/4538/5314/products/KLopenpage.jpg?v=1633033061\"},\"aspect_ratio\":1.551,\"height\":1225,\"media_type\":\"image\",\"src\":\"https://cdn.shopify.com/s/files/1/0058/4538/5314/products/KLopenpage.jpg?v=1633033061\",\"width\":1900},{\"alt\":null,\"id\":20647777140839,\"position\":8,\"preview_image\":{\"aspect_ratio\":1.551,\"height\":1225,\"width\":1900,\"src\":\"https://cdn.shopify.com/s/files/1/0058/4538/5314/products/Acknowledgementopenpage.jpg?v=1633033061\"},\"aspect_ratio\":1.551,\"height\":1225,\"media_type\":\"image\",\"src\":\"https://cdn.shopify.com/s/files/1/0058/4538/5314/products/Acknowledgementopenpage.jpg?v=1633033061\",\"width\":1900},{\"alt\":null,\"id\":20647777828967,\"position\":9,\"preview_image\":{\"aspect_ratio\":0.8,\"height\":2000,\"width\":1600,\"src\":\"https://cdn.shopify.com/s/files/1/0058/4538/5314/products/ABCBookForWeb2000px-9.jpg?v=1633033061\"},\"aspect_ratio\":0.8,\"height\":2000,\"media_type\":\"image\",\"src\":\"https://cdn.shopify.com/s/files/1/0058/4538/5314/products/ABCBookForWeb2000px-9.jpg?v=1633033061\",\"width\":1600},{\"alt\":null,\"id\":20647777861735,\"position\":10,\"preview_image\":{\"aspect_ratio\":0.8,\"height\":2000,\"width\":1600,\"src\":\"https://cdn.shopify.com/s/files/1/0058/4538/5314/products/ABCBookForWeb2000px-10.jpg?v=1633033061\"},\"aspect_ratio\":0.8,\"height\":2000,\"media_type\":\"image\",\"src\":\"https://cdn.shopify.com/s/files/1/0058/4538/5314/products/ABCBookForWeb2000px-10.jpg?v=1633033061\",\"width\":1600},{\"alt\":null,\"id\":20647777894503,\"position\":11,\"preview_image\":{\"aspect_ratio\":0.8,\"height\":2000,\"width\":1600,\"src\":\"https://cdn.shopify.com/s/files/1/0058/4538/5314/products/ABCBookForWeb2000px-11.jpg?v=1633033061\"},\"aspect_ratio\":0.8,\"height\":2000,\"media_type\":\"image\",\"src\":\"https://cdn.shopify.com/s/files/1/0058/4538/5314/products/ABCBookForWeb2000px-11.jpg?v=1633033061\",\"width\":1600}],\"requires_selling_plan\":false,\"selling_plan_groups\":[]}",
      stock: "{\"Default Title\":17930}",
      purchasesPerHour: -1,
      regularPrice: 1499,
      currentPrice: 1499,
      firstSeen: 1718142930418,
      available: 1
    });
  }

  return {
    popularProducts
  }
}) satisfies PageServerLoad
